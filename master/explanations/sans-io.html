<!-- Include Index in the sidebar -->
<!-- https://stackoverflow.com/a/37843854 -->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Why write a Sans-IO library? &mdash; PandABlocks-client 0.0+untagged.g5a03b65 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/PandA-logo.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How fast can we write HDF files?" href="performance.html" />
    <link rel="prev" title="How to efficiently poll for changes" href="../how-to/poll-changes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> PandABlocks-client
          

          
            
            <img src="../_static/PandA-logo-for-black-background.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/load-save.html">Commandline Load/Save Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/control.html">Interactive Control Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/commandline-hdf.html">Commandline Capture of HDF Files Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/library-hdf.html">How to use the library to capture HDF files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/poll-changes.html">How to efficiently poll for changes</a></li>
</ul>
<p class="caption"><span class="caption-text">Explanations</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Why write a Sans-IO library?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#connections">Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wrappers">Wrappers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">How fast can we write HDF files?</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/contributing.html">Contributing</a></li>
</ul>

            
          
    <a href="../genindex.html">Index</a>
    
    <p class="caption"><span class="caption-text">Versions</span></p>
    <ul>
    <li><a href="../../0.0.9/explanations/sans-io.html">0.0.9</a></li>
    <li><a href="../../0.1.0/explanations/sans-io.html">0.1.0</a></li>
    <li><a href="sans-io.html">master</a></li>
    </ul>
    
  
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PandABlocks-client</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Why write a Sans-IO library?</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/explanations/sans-io.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="why-write-a-sans-io-library">
<span id="sans-io"></span><h1>Why write a Sans-IO library?<a class="headerlink" href="#why-write-a-sans-io-library" title="Permalink to this headline">¶</a></h1>
<p>As the <a class="reference external" href="https://sans-io.readthedocs.io/">reference</a> says: <em>Reusability</em>. The protocol can be coded in a separate
class to the I/O allowing integration into a number of different concurrency
frameworks.</p>
<p>For instance, we need both a <a class="reference internal" href="../reference/api.html#pandablocks.blocking.BlockingClient" title="pandablocks.blocking.BlockingClient"><code class="xref any py py-class docutils literal notranslate"><span class="pre">BlockingClient</span></code></a> and an <a class="reference internal" href="../reference/api.html#pandablocks.asyncio.AsyncioClient" title="pandablocks.asyncio.AsyncioClient"><code class="xref any py py-class docutils literal notranslate"><span class="pre">AsyncioClient</span></code></a>. If we had
coded the protocol in either of them it would not be usable in the other. Much
better to put it in a separate class and feed it bytes off the wire. We call
this protocol encapsulation a Connection.</p>
<div class="section" id="connections">
<h2>Connections<a class="headerlink" href="#connections" title="Permalink to this headline">¶</a></h2>
<p>The PandA TCP server exposes a Control port and a Data port, so there are
corresponding <a class="reference internal" href="../reference/api.html#pandablocks.connections.ControlConnection" title="pandablocks.connections.ControlConnection"><code class="xref any py py-class docutils literal notranslate"><span class="pre">ControlConnection</span></code></a> and <a class="reference internal" href="../reference/api.html#pandablocks.connections.DataConnection" title="pandablocks.connections.DataConnection"><code class="xref any py py-class docutils literal notranslate"><span class="pre">DataConnection</span></code></a> objects:</p>
<dl class="py class">
<dt>
<em class="property">class </em><code class="sig-prename descclassname">pandablocks.connections.</code><code class="sig-name descname">ControlConnection</code><a class="reference internal" href="../_modules/pandablocks/connections.html#ControlConnection"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Sans-IO connection to control port of PandA TCP server, supporting a
Command based interface. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cc</span> <span class="o">=</span> <span class="n">ControlConnection</span><span class="p">()</span>
<span class="c1"># Connection says what bytes should be sent to execute command</span>
<span class="n">to_send</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">to_send</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># Repeatedly process bytes from the server looking for responses</span>
    <span class="n">from_server</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">command</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">cc</span><span class="o">.</span><span class="n">receive_bytes</span><span class="p">(</span><span class="n">from_server</span><span class="p">):</span>
        <span class="n">do_something_with</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/api.html#pandablocks.connections.ControlConnection.send" title="pandablocks.connections.ControlConnection.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> method takes a <a class="reference internal" href="../reference/api.html#pandablocks.commands.Command" title="pandablocks.commands.Command"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Command</span></code></a> subclass and
returns the bytes that should be sent to the PandA. Whenever bytes are
received from the socket they can be passed to
<a class="reference internal" href="../reference/api.html#pandablocks.connections.ControlConnection.receive_bytes" title="pandablocks.connections.ControlConnection.receive_bytes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">receive_bytes()</span></code></a> which will return an iterator of
<code class="docutils literal notranslate"><span class="pre">(command,</span> <span class="pre">response)</span></code> tuples. The response type will depend on the
command. For instance <a class="reference internal" href="../reference/api.html#pandablocks.commands.Get" title="pandablocks.commands.Get"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Get</span></code></a> returns <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)"><code class="xref any docutils literal notranslate"><span class="pre">bytes</span></code></a> or a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.9)"><code class="xref any docutils literal notranslate"><span class="pre">list</span></code></a> of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)"><code class="xref any docutils literal notranslate"><span class="pre">bytes</span></code></a> of the
field value, and <a class="reference internal" href="../reference/api.html#pandablocks.commands.GetFields" title="pandablocks.commands.GetFields"><code class="xref any py py-class docutils literal notranslate"><span class="pre">GetFields</span></code></a> returns a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><code class="xref any docutils literal notranslate"><span class="pre">dict</span></code></a> mapping <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><code class="xref any docutils literal notranslate"><span class="pre">str</span></code></a> field name to
<a class="reference internal" href="../reference/api.html#pandablocks.responses.FieldType" title="pandablocks.responses.FieldType"><code class="xref any py py-class docutils literal notranslate"><span class="pre">FieldType</span></code></a>.</p>
</dd></dl>

<dl class="py class">
<dt>
<em class="property">class </em><code class="sig-prename descclassname">pandablocks.connections.</code><code class="sig-name descname">DataConnection</code><a class="reference internal" href="../_modules/pandablocks/connections.html#DataConnection"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Sans-IO connection to data port of PandA TCP server, supporting an
flushable iterator interface. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">ControlConnection</span><span class="p">()</span>
<span class="c1"># Single connection string to send</span>
<span class="n">to_send</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">to_send</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># Repeatedly process bytes from the server looking for data</span>
    <span class="n">from_server</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dc</span><span class="o">.</span><span class="n">receive_bytes</span><span class="p">(</span><span class="n">from_server</span><span class="p">):</span>
        <span class="n">do_something_with</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/api.html#pandablocks.connections.DataConnection.connect" title="pandablocks.connections.DataConnection.connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">connect()</span></code></a> method takes any connection arguments
and returns the bytes that should be sent to the PandA to make the initial
connection. Whenever bytes are received from the socket they can be passed
to <a class="reference internal" href="../reference/api.html#pandablocks.connections.DataConnection.receive_bytes" title="pandablocks.connections.DataConnection.receive_bytes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">receive_bytes()</span></code></a> which will return an iterator of
<a class="reference internal" href="../reference/api.html#pandablocks.responses.Data" title="pandablocks.responses.Data"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Data</span></code></a> objects. Intermediate <a class="reference internal" href="../reference/api.html#pandablocks.responses.FrameData" title="pandablocks.responses.FrameData"><code class="xref any py py-class docutils literal notranslate"><span class="pre">FrameData</span></code></a> can be squashed together by passing
<code class="docutils literal notranslate"><span class="pre">flush_every_frame=False</span></code>, then explicitly calling
<a class="reference internal" href="../reference/api.html#pandablocks.connections.DataConnection.flush" title="pandablocks.connections.DataConnection.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">flush()</span></code></a> when they are required.</p>
</dd></dl>

</div>
<div class="section" id="wrappers">
<h2>Wrappers<a class="headerlink" href="#wrappers" title="Permalink to this headline">¶</a></h2>
<p>Of course, these Connections are useless without connecting some I/O. To aid with
this, wrappers are included for use in <a class="reference internal" href="../reference/api.html#module-pandablocks.asyncio" title="pandablocks.asyncio"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a> and blocking programs. They expose
slightly different APIs to make best use of the features of their respective concurrency frameworks.</p>
<p>For example, to send multiple commands in fields with the blocking wrapper:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">BlockingClient</span><span class="p">(</span><span class="s2">&quot;hostname&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="n">resp1</span><span class="p">,</span> <span class="n">resp2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="n">cmd1</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">])</span>
</pre></div>
</div>
<p>while with asyncio we would:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">with</span> <span class="n">AsyncioClient</span><span class="p">(</span><span class="s2">&quot;hostname&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="n">resp1</span><span class="p">,</span> <span class="n">resp2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">cmd1</span><span class="p">),</span>
        <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">cmd2</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The first has the advantage of simplicity, but blocks while waiting for data.
The second allows multiple co-routines to use the client at the same time at the
expense of a more verbose API.</p>
<p>The wrappers do not guarantee feature parity, for instance the <code class="docutils literal notranslate"><span class="pre">flush_period</span></code>
option is only available in the asyncio wrapper.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="performance.html" class="btn btn-neutral float-right" title="How fast can we write HDF files?" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../how-to/poll-changes.html" class="btn btn-neutral float-left" title="How to efficiently poll for changes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Diamond Light Source

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>